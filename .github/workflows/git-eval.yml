name: Git-Eval D Rank

on:
  push:
    branches: ["**"]

jobs:
  evaluate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: CI checks
        id: ci
        run: |
          CI_SCORE=0
          CI_FEEDBACK=""
          TOTAL_MSGS=$(git rev-list --count HEAD)

          # Meaningful commit messages (15pts)
          BAD_MSGS=$(git log --format='%s' | grep -ciE '^(initial commit|update|fix|test|asdf|aaa|wip|tmp|\.+)$' || true)
          if [ "$TOTAL_MSGS" -gt 0 ]; then
            GOOD_RATIO=$(( (TOTAL_MSGS - BAD_MSGS) * 100 / TOTAL_MSGS ))
            if [ "$GOOD_RATIO" -ge 80 ]; then
              CI_SCORE=$((CI_SCORE + 15))
              CI_FEEDBACK="${CI_FEEDBACK}‚úÖ „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÂÖ∑‰ΩìÁöÑ (${GOOD_RATIO}%)\n"
            elif [ "$GOOD_RATIO" -ge 50 ]; then
              CI_SCORE=$((CI_SCORE + 8))
              CI_FEEDBACK="${CI_FEEDBACK}‚ö†Ô∏è „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Çí„ÇÇ„ÅÜÂ∞ë„ÅóÂÖ∑‰ΩìÁöÑ„Å´\n"
            else
              CI_FEEDBACK="${CI_FEEDBACK}‚ùå „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÊäΩË±°ÁöÑ„Åô„Åé„Åæ„Åô\n"
            fi
          fi

          # Multiple commits (10pts)
          if [ "$TOTAL_MSGS" -ge 5 ]; then
            CI_SCORE=$((CI_SCORE + 10))
            CI_FEEDBACK="${CI_FEEDBACK}‚úÖ „Ç≥„Éü„ÉÉ„ÉàÂàÜÂâ≤ OK (${TOTAL_MSGS})\n"
          elif [ "$TOTAL_MSGS" -ge 3 ]; then
            CI_SCORE=$((CI_SCORE + 5))
            CI_FEEDBACK="${CI_FEEDBACK}‚ö†Ô∏è „ÇÇ„ÅÜÂ∞ë„ÅóÁ¥∞„Åã„Åè„Ç≥„Éü„ÉÉ„Éà„Çí\n"
          else
            CI_FEEDBACK="${CI_FEEDBACK}‚ùå „Ç≥„Éü„ÉÉ„ÉàÊï∞„ÅåÂ∞ë„Å™„Åô„Åé„Åæ„Åô\n"
          fi

          # Non-main branch (15pts)
          CURRENT_BRANCH="${GITHUB_REF_NAME}"
          if [ "$CURRENT_BRANCH" != "main" ] && [ "$CURRENT_BRANCH" != "master" ]; then
            CI_SCORE=$((CI_SCORE + 15))
            CI_FEEDBACK="${CI_FEEDBACK}‚úÖ „Éñ„É©„É≥„ÉÅ '${CURRENT_BRANCH}' „Åß‰ΩúÊ•≠\n"
          else
            BRANCH_COUNT=$(git branch -r | grep -v 'HEAD' | grep -v 'main$' | grep -v 'master$' | wc -l)
            if [ "$BRANCH_COUNT" -gt 0 ]; then
              CI_SCORE=$((CI_SCORE + 7))
              CI_FEEDBACK="${CI_FEEDBACK}‚ö†Ô∏è „Éñ„É©„É≥„ÉÅ„ÅØ„ÅÇ„Çã„Åå main „Å´Áõ¥Êé• push\n"
            else
              CI_FEEDBACK="${CI_FEEDBACK}‚ùå „Éñ„É©„É≥„ÉÅ„ÇíÂàá„Å£„Å¶‰ΩúÊ•≠„Åó„Åæ„Åó„Çá„ÅÜ\n"
            fi
          fi

          # PR (10pts)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CI_SCORE=$((CI_SCORE + 10))
            CI_FEEDBACK="${CI_FEEDBACK}‚úÖ PR ‰ΩúÊàêÊ∏à„Åø\n"
          else
            CI_FEEDBACK="${CI_FEEDBACK}‚è≠Ô∏è PR ÁµåÁî±„Å†„Å®„Éú„Éº„Éä„Çπ„ÅÇ„Çä\n"
          fi

          # No CRLF (10pts)
          if grep -rPl '\r$' --include='*.py' --include='*.js' --include='*.ts' --include='*.go' --include='*.rs' --include='*.java' --include='*.md' . 2>/dev/null | grep -q .; then
            CI_FEEDBACK="${CI_FEEDBACK}‚ùå CRLF Ê§úÂá∫\n"
          else
            CI_SCORE=$((CI_SCORE + 10))
            CI_FEEDBACK="${CI_FEEDBACK}‚úÖ ÊîπË°å„Ç≥„Éº„Éâ OK\n"
          fi

          echo "ci_score=$CI_SCORE" >> $GITHUB_OUTPUT
          {
            echo "ci_feedback<<CI_EOF"
            echo -e "$CI_FEEDBACK"
            echo "CI_EOF"
          } >> $GITHUB_OUTPUT

      - name: Collect git history
        id: source
        run: |
          {
            echo "code<<CODE_EOF"
            echo "=== „Ç≥„Éü„ÉÉ„ÉàÂ±•Ê≠¥ ==="
            git log --format='%h %s' -20
            echo ""
            echo "=== Áõ¥Ëøë„ÅÆÂ∑ÆÂàÜ ==="
            git diff HEAD~1 --stat 2>/dev/null || echo "(Â∑ÆÂàÜ„Å™„Åó)"
            echo ""
            echo "=== „ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ ==="
            find . -path './.git' -prune -o -path './node_modules' -prune -o \
              \( -name '*.py' -o -name '*.js' -o -name '*.ts' -o -name '*.go' -o -name '*.rs' -o -name '*.java' -o -name '*.rb' \) \
              -print | head -15 | while read f; do
              echo "--- $f ---"
              head -150 "$f"
            done
            echo "CODE_EOF"
          } >> $GITHUB_OUTPUT

      - name: LLM evaluation
        id: llm
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "llm_score=0" >> $GITHUB_OUTPUT
            echo "llm_feedback=‚è≠Ô∏è ANTHROPIC_API_KEY Êú™Ë®≠ÂÆö" >> $GITHUB_OUTPUT
            exit 0
          fi

          SOURCE_CODE="${{ steps.source.outputs.code }}"

          PROMPT="„ÅÇ„Å™„Åü„ÅØ„ÉÅ„Éº„É†ÈñãÁô∫„ÅÆÊåáÂ∞éËÄÖ„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆ Git Â±•Ê≠¥„Å®„Ç≥„Éº„Éâ„Çí D „É©„É≥„ÇØÔºàDeveloper: „ÉÅ„Éº„É†ÈñãÁô∫„ÅÆ‰ΩúÊ≥ïÔºâ„ÅÆÂü∫Ê∫ñ„ÅßË©ï‰æ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          D „É©„É≥„ÇØ„ÅØ„Äå„ÉÅ„Éº„É†„ÅßÈñãÁô∫„Åô„Çã‰ΩúÊ≥ï„Äç„ÅåË∫´„Å´„Å§„ÅÑ„Å¶„ÅÑ„Çã„Åã„ÇíË¶ã„Åæ„Åô„ÄÇ

          Ë©ï‰æ°Âü∫Ê∫ñÔºàÂêÑÈ†ÖÁõÆ 0„ÄúÊåáÂÆöÁÇπ„ÅßÊé°ÁÇπÔºâ:
          1. „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË≥™ÔºàÂÖ∑‰ΩìÊÄß„ÄÅ‰∏ÄË≤´ÊÄßÔºâ: 0„Äú20 ÁÇπ
          2. „Ç≥„Éº„Éâ„ÅÆÂàÜÂâ≤„Å®Â§âÊõ¥„ÅÆÁ≤íÂ∫¶„ÅåÈÅ©Âàá„Åã: 0„Äú20 ÁÇπ

          ÂøÖ„Åö‰ª•‰∏ã„ÅÆ JSON ÂΩ¢Âºè„ÅßÂõûÁ≠î:
          {\"commit_quality\": ÁÇπÊï∞, \"granularity\": ÁÇπÊï∞, \"feedback\": \"Êó•Êú¨Ë™û„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ\"}

          Git Â±•Ê≠¥„Å®„Ç≥„Éº„Éâ:
          ${SOURCE_CODE}"

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              '{model: "claude-sonnet-4-20250514", max_tokens: 1024, messages: [{role: "user", content: $prompt}]}')")

          LLM_TEXT=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          if [ -n "$LLM_TEXT" ]; then
            LLM_JSON=$(echo "$LLM_TEXT" | grep -oP '\{[^{}]*\}' | head -1)
            if [ -n "$LLM_JSON" ]; then
              CQ=$(echo "$LLM_JSON" | jq -r '.commit_quality // 0')
              GR=$(echo "$LLM_JSON" | jq -r '.granularity // 0')
              LLM_FB=$(echo "$LLM_JSON" | jq -r '.feedback // "Ë©ï‰æ°ÂÆå‰∫Ü"')
              LLM_SCORE=$((CQ + GR))
              echo "llm_score=$LLM_SCORE" >> $GITHUB_OUTPUT
              {
                echo "llm_feedback<<LLM_EOF"
                echo "üìù „É°„ÉÉ„Çª„Éº„Ç∏ÂìÅË≥™ ${CQ}/20 | Â§âÊõ¥Á≤íÂ∫¶ ${GR}/20"
                echo "$LLM_FB"
                echo "LLM_EOF"
              } >> $GITHUB_OUTPUT
            else
              echo "llm_score=0" >> $GITHUB_OUTPUT
              echo "llm_feedback=‚ö†Ô∏è LLM ÂøúÁ≠î„ÅÆËß£Êûê„Å´Â§±Êïó" >> $GITHUB_OUTPUT
            fi
          else
            echo "llm_score=0" >> $GITHUB_OUTPUT
            echo "llm_feedback=‚ö†Ô∏è LLM API „Ç®„É©„Éº" >> $GITHUB_OUTPUT
          fi

      - name: Send results to Git-Eval
        if: always()
        env:
          WEBHOOK_SECRET: ${{ secrets.GIT_EVAL_SECRET }}
          WEBHOOK_URL: ${{ secrets.GIT_EVAL_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ] || [ -z "$WEBHOOK_SECRET" ]; then
            echo "Webhook not configured, skipping"
            exit 0
          fi

          CI_SCORE=${{ steps.ci.outputs.ci_score }}
          LLM_SCORE=${{ steps.llm.outputs.llm_score }}
          TOTAL=$((CI_SCORE + LLM_SCORE))

          FEEDBACK="„ÄêCI/CD „ÉÅ„Çß„ÉÉ„ÇØ (60ÁÇπ)„Äë\n${{ steps.ci.outputs.ci_feedback }}\n„ÄêLLM Ë©ï‰æ° (40ÁÇπ)„Äë\n${{ steps.llm.outputs.llm_feedback }}\n\nÂêàË®à„Çπ„Ç≥„Ç¢: ${TOTAL}/100"

          BODY=$(jq -n \
            --arg user "${{ github.actor }}" \
            --argjson score "$TOTAL" \
            --arg feedback "$FEEDBACK" \
            '{github_username: $user, score: $score, feedback: $feedback}')

          SIG=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* //')

          curl -sf -X POST "${WEBHOOK_URL}/webhook/eval" \
            -H "Content-Type: application/json" \
            -H "X-Signature-256: sha256=${SIG}" \
            -d "$BODY"
